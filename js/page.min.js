function init_typeahead(){"use strict";for(var t=function(t){return function(e,n){var a,o=[],i=[],r=courseList;for(e=e.toLowerCase(),a=0;a<t.length;a+=1){var s=t[a];if(!(r.indexOf(s)>=0)){var c=s+" - "+timetableData[s][0],l=c.toLowerCase().indexOf(e);l>0?o.push(c):0===l&&i.push(c)}}i.sort(),i.length<10&&o.length>0&&(o.sort(),i=i.concat(o)),n(i.slice(0,10))}};void 0===$().typeahead;);$(".typeahead.coursein").typeahead({name:"courses",source:t(Object.keys(timetableData))})}function restoreState(t){"use strict";var o,e=Cookies.getJSON("options"),n=Cookies.getJSON("courses")||[];if(classLocations=Cookies.getJSON("classLocations")||{},customClasses=Cookies.getJSON("custom")||[],void 0!==e){for(o=0;o<n.length;o+=1)"CBS"!==n[o]&&timetableData.hasOwnProperty(n[o])&&addCourse(n[o]+" - "+timetableData[n[o]][0],!1,!1);for(o=0;o<customClasses.length;o+=1){var i=addCourse(customClasses[o].component,!0,!1);i.data("custom",customClasses[o].course)}document.getElementById("tbt").checked=e.cbs.tbt,document.getElementById("bib").checked=e.cbs.bib,document.getElementById("ctr").checked=e.cbs.ctr,document.getElementById("cth").checked=e.cbs.cth,document.getElementById("showcap").checked=e.showcap,document.getElementById("fullclasses").checked=e.fullclasses,document.getElementById("showloc").checked=e.showloc,document.getElementById("canclash").checked=e.canclash,"{}"!==JSON.stringify(classLocations)&&generate(!0,!0)}}function saveState(t){"use strict";if(finishedInit){Cookies.set("courses",courseList,{expires:182}),Cookies.set("custom",customClasses,{expires:182});var e={cbs:{}};e.cbs.tbt=document.getElementById("tbt").checked,e.cbs.bib=document.getElementById("bib").checked,e.cbs.ctr=document.getElementById("ctr").checked,e.cbs.cth=document.getElementById("cth").checked,e.fullclasses=optionMemory.fullclasses,e.canclash=optionMemory.canclash,e.showcap=document.getElementById("showcap").checked,e.showloc=document.getElementById("showloc").checked,Cookies.set("options",e,{expires:182}),Cookies.set("classLocations",classLocations,{expires:182})}}function restoreClasses(){"use strict";function t(t,e){t.detach().appendTo(e).css({position:"absolute",left:0,top:0})}var e,n,o,i,r;for(e in classLocations)classLocations.hasOwnProperty(e)&&(n=$('[id="'+e+'"]'),o=shadowList[e],i=$("#"+classLocations[e]),r=i.find(o),t(n,i),n.find(".class-capacity").html(r.data("capacity")))}function removeCourse(t){"use strict";var e=$(t.currentTarget).parents(".course"),n=e.children().first(),o=n.html().replace(/ -.+/,"");if(e.data("custom")!==!1){for(var i=0;i<customClasses.length;i+=1)if(customClasses[i].course===e.data("custom")){customClasses.splice(i,1);break}}else-1!==courseList.indexOf(o)&&courseList.splice(courseList.indexOf(o),1);e.children().fadeOut(200,function(){e.children().show().css("visibility","hidden"),e.slideUp(200,function(){e.remove(),0===$("#courses").children().length&&$("#courses").css("margin-bottom","-10px")})}),saveState()}function addCourse(t,e,n){"use strict";e!==!0&&courseList.push(t.replace(/ -.*/,""));var o=$("#courses"),i=$("<span>").addClass("glyphicon glyphicon-remove-circle glyphicon-clickable remove-icon").attr("aria-hidden",!0).attr("data-toggle","tooltip").attr("title","Remove").click(removeCourse),r=$("<span>").addClass("glyphicon glyphicon-edit glyphicon-clickable edit-icon").attr("data-toggle","tooltip").attr("title","Edit").attr("aria-hidden",!0).attr("data-toggle","modal").attr("data-target","#customClass").click(showEdit),a=$("<div>").append(i),s=e!==!0?a:a.prepend(r),c=$('<div class="course">').html("<div>"+t+"</div>").append(s).data("custom",!1);return o.append(c).css("margin-bottom",0),n!==!1&&(c.children().hide(),c.hide().slideDown(200,function(){c.children().fadeIn(200)})),saveState(),c}function to24H(t){if(void 0===t||0===t.length)return void 0;var e=parseInt(t.replace(/\D.*/,""))%12,n=0!==parseInt(t.replace(/\d+:/,"").replace(/ .M/,""));return e+(-1!==t.indexOf("PM")?12:0)+(n?.5:0)}function to12H(t){if(void 0===t||""===t)return void 0;var e=Math.floor(t%12===0?12:t%12),n=t%1===0?"00":"30",o=(10>e?"0"+e:e)+":"+n+" "+(t>=12?"PM":"AM");return o}function getRandomInt(t,e){return t=Math.ceil(t||0),e=Math.floor(e||1e6),Math.floor(Math.random()*(e-t))+t}function uniqueID(){var e,t="custom"+getRandomInt()+"_";for(e=0;e<customClasses.length;e+=1)if(customClasses[e].course===t)return uniqueID();return t}function addCustom(){"use strict";for(var t=document.getElementById("customTitle").value,e=document.getElementById("customLocation").value,n=to24H(document.getElementById("startTime").value),o=to24H(document.getElementById("endTime").value),i=$('input[type="radio"][name="customDay"]').parent(".active").data("day"),r=i+" "+n+(o-n!==1?"-"+o:""),a=document.getElementById("customID").value||uniqueID(),s=getComputedStyle(document.querySelector('input[type="radio"][name="customColour"]:checked'),":before").getPropertyValue("background-color").replace(/rgba\(|, 0\.85\)/g,""),c={time:r,status:"O",enrols:"0,1",course:a,component:t,location:[e],colour:s},l=0;l<customClasses.length;l+=1)if(customClasses[l].course===a){customClasses.splice(l,1);break}customClasses.push(c);var d;"Edit"===document.getElementById("addcustom").innerHTML?($("#courses").children().filter(function(t,e){return $(e).data("custom")===a}).remove(),d=addCourse(t,!0,!1)):d=addCourse(t,!0),d.data("custom",a)}function showEdit(t){"use strict";for(var i,e=$(t.target).parents(".course"),n=e.children().first().html(),o=e.data("custom"),r=0;r<customClasses.length;r+=1)if(customClasses[r].course===o){i=customClasses[r];break}void 0===i&&pageError("Oops!","The list of your courses has become a bit confused. Please try reloading the page, or adding your courses again.");var a=i.time.replace(/.* /,"").split("-"),s=i.time.replace(/ .*/,"");1===a.length&&(a[1]=+a[0]+1),document.getElementById("customID").value=o,document.getElementById("addcustom").innerHTML="Edit",document.getElementById("customTitle").value=n,document.getElementById("customLocation").value=i.location,document.getElementById("startTime").value=to12H(a[0]),document.getElementById("endTime").value=to12H(a[1]),$('input[type="radio"][name="customColour"]').attr("checked",!1).each(function(t,e){return getComputedStyle(e,":before").getPropertyValue("background-color").replace(/rgba\(|, 0\.85\)/g,"")===i.colour?($(e).attr("checked",!0),!1):void 0}),$('input[type="radio"][name="customDay"]').parent().removeClass("active"),$('input[type="radio"][name="customDay"]').parent('[data-day="'+s+'"]').addClass("active"),checkFields()}function checkFields(){var t=document.getElementById("startTime"),e=document.getElementById("endTime"),n=to24H(t.value),o=to24H(e.value),i=$('input[type="radio"][name="customDay"]').parent(".active").data("day"),r=document.getElementById("customTitle").value,a=document.getElementById("addcustom");return void 0===o&&void 0!==n&&(o=to12H(n+1),e.value=o),void 0===n||void 0===o?(a.disabled=!0,!1):n>=o?(e.style.color="red",a.disabled=!0,!1):(e.style.color="",void 0===i||void 0===r||""===r?(a.disabled=!0,!1):(a.disabled=!1,!0))}function timetableToPNG(){"use strict";var t=document.getElementById("timetable");$(t).width();$(t).removeClass("scroll-x"),$(t).width(720);var n,o=/constructor/i.test(window.HTMLElement)||function(t){return"[object SafariRemoteNotification]"===t.toString()}(!window.safari||"undefined"!=typeof safari&&safari.pushNotification),i=!!document.documentMode,r=!i&&!!window.StyleMedia;n=!o&&!r&&!i,n?domtoimage.toPng(t).then(function(e){$(t).css("width","auto"),$(t).addClass("scroll-x"),download(e,"timetable.png","image/png")}):domtoimage.toSvg(t).then(function(e){$(t).addClass("scroll-x"),$(t).css("width","auto"),download(e,"timetable.svg","image/svg+xml")})}function hasClass(t,e){"use strict";var n=" "+t.className+" ";return-1!==n.indexOf(" "+e+" ")}function createTable(){"use strict";var l,d,u,h,t=$("#timetable").find(".row"),e='<div class="col col-1 head first"></div><div class="col head">Monday</div><div class="col head">Tuesday</div><div class="col head">Wednesday</div><div class="col head">Thursday</div><div class="col head">Friday</div>',n="",o='<div class="w-100"></div>',i=8,r=21,a=function(t,e){var n="small",o=t;return t+=":00",e===!0&&(o+="_30",t="",n="half"),'<div class="col col-1 body first '+n+'" id="ttrow_'+o+'">'+(e?"":"<div>"+t.replace("_",":")+"</div>")+"</div>"},s=function(t,e,n){var o="";return n===!0&&(t+="_30",o=" half"),'<div class="col body'+o+'" id="'+e+"_"+t+'"></div>'},c=["M","T","W","H","F"];for(l=0;2*(r-i)>l;l+=1){for(d=i+Math.floor(l/2),h=l%2===1,n+=a(d,h),u=0;u<c.length;u+=1)n+=s(d,c[u],h);l!==2*(r-i)-1&&(n+=o)}t.html(e+o+n)}function showEmpty(){"use strict";$("#timetable").find(".body").css("display","block")}function hideEmpty(t,e){"use strict";var o,n=$("#timetable").find(".body");for(o=0;o<n.length;o+=1){var i=n[o],r=ttHeadHeight+ttCellHeight*+i.id.replace(/\D+_/,"").replace("_30","");(t>r||r>=e)&&(i.style.display="none")}}function clearWarning(){document.getElementById("generateWarning");optionMemory.fullclasses=document.getElementById("fullclasses").checked,optionMemory.canclash=document.getElementById("canclash").checked,updateWarning()}function updateWarning(){var t=document.getElementById("generateWarning");document.getElementById("fullclasses").checked!==optionMemory.fullclasses||document.getElementById("canclash").checked!==optionMemory.canclash?(t.innerHTML="Some options have not yet taken effect. Please generate a new timetable to include these options.",t.style.display="block"):(t.innerHTML="",t.style.display="none")}function getColour(t){"use strict";var e=[[19,111,225],[160,29,33],[14,147,40],[102,44,145],[255,107,0],[10,28,210],[238,46,20],[27,98,46]];return e[t%e.length].join(",")}function startDrag(t,e){"use strict";var n=$(t.target),o=n.attr("id"),i=shadowList[o];i.fadeIn(200),$('.class-drag[id^="'+o.replace(/\d$/,"")+'"]').addClass("locked")}function stopDrag(t,e){"use strict";function n(t,e){t.detach().appendTo(e).css({left:0,top:0})}var a,s,o=$(t.target),i=o.width()/2*o.width()/2,r=null;$(".class-shadow:visible").each(function(){var t=$(this).offset(),e=o.offset(),n=Math.pow(t.left-e.left,2)+Math.pow(t.top-e.top,2);i>n&&(i=n,r=$(this))}),null!==r&&(a=o.attr("id"),s=shadowList[a].index(r),$('.class-drag[id^="'+a.replace(/\d$/,"")+'"]').each(function(){var t=$(this),e=$(shadowList[t.attr("id")][s]);n(t,e.parent()),t.find(".class-capacity").html(e.data("capacity")),t.find(".class-location").html(e.data("location")),classLocations[t.attr("id")]=e.parent().attr("id")})),$(".class-shadow").fadeOut(200),$(".class-drag.locked").removeClass("locked"),saveState()}function unique(t,e){"use strict";var r,n=[],o=[],i=[];for(r=0;r<t.length;r+=1)-1===i.indexOf(String(t[r]))&&(n.push(t[r]),i.push(String(t[r])),void 0!==e&&o.push(e[r]));for(r=0;r<n.length;r+=1)t[r]=n[r],void 0!==e&&(e[r]=o[r]);for(;r<t.length;)t.pop(),void 0!==e&&e.pop()}function createClassDiv(t,e,n,o,i,r,a){"use strict";var s=$("<div>").attr("id",o).addClass("class-drag").draggable({stack:".class-drag",scroll:!0,containment:a,start:startDrag,stop:stopDrag}),c=s[0];return c.innerHTML="<div>"+t+e+n+"</div>",c.style.position="absolute",c.style.backgroundColor="rgb("+i+")",c.style.height=ttCellHeight*r+"px",s}function createClass(t,e,n){"use strict";var l,d,u,h,f,p,m,g,o=t.time,i=t.enrols,r=t.course,a=t.component,s=t.location,c=t.colour||getColour(e),y='<div style="font-weight: bold">'+(0!==r.indexOf("custom")&&"CBS"!==r?r+": "+a:a)+"</div>",v=0,b=$("#timetable").find(".row");for(i=0!==r.indexOf("custom")&&"CBS"!==r?'<div class="class-capacity">'+i.replace(","," / ")+"</div>":"",u=0;u<o.length;u+=1){l=o[u],d='<div class="class-location">'+s[u]+"</div>";var w=l.join(",")+r+a;-1===n.indexOf(w)?(n.push(w),h=r+a+"_"+(u-v),f=l[2]-l[1],p=(l[0]+"_"+l[1]).replace(".5","_30"),m=$("#"+p),g=createClassDiv(y,d,i,h,c,f,b),""===i&&g.addClass("nocapacity"),g.appendTo(m),classList.push(g),classLocations.hasOwnProperty(h)||(classLocations[h]=p)):v+=1}document.getElementById("showcap").checked||$(".class-capacity").hide(),document.getElementById("showloc").checked||$(".class-location").hide()}function createShadow(t,e){"use strict";var n=t.time,o=t.course+t.component+"_",i=t.enrols,r=t.location,a=t.colour||getColour(e),s=1/0,c=-(1/0);(0===o.indexOf("CBS")||0===t.course.indexOf("custom"))&&(i=""),unique(n,r);var l;for(l=0;l<n.length;l+=1){var b,d=n[l],h=(d.join(","),r[l]),f=o+l,p=d[2]-d[1],m=ttCellHeight*p,g=(d[0]+"_"+d[1]).replace(".5","_30"),y=$("#"+g),v=ttHeadHeight+d[1]*ttCellHeight;b=$('<div class="class-shadow">'),b[0].style.backgroundColor="rgba("+a+", 0.7)",b[0].style.height=m+"px",b.data("capacity",i.replace(","," / ")),b.data("location",h.replace(","," / ")),b.appendTo(y),shadowList.hasOwnProperty(f)?shadowList[f]=shadowList[f].push(b):shadowList[f]=b,s=Math.min(s,-1===g.indexOf("_30")?v:v-ttCellHeight/2),c=Math.max(c,v+m)}return{min:s,max:c}}function pageError(t,e){var n=$("<div>").addClass("alert alert-warning alert-dismissible fade show").attr("role","alert"),o=$('<button type="button" data-dismiss="alert" aria-label="Close">').addClass("close").html('<span aria-hidden="true">&times;</span>'),i="<strong>"+t+"</strong> "+e,r=$("#alert-space");n.html(i).prepend(o),n.appendTo(r),r.children().length>3&&r.children().first().alert("close")}function pageNotice(t,e){var n=$("<div>").addClass("alert alert-success alert-dismissible fade show").attr("role","alert"),o=$('<button type="button" data-dismiss="alert" aria-label="Close">').addClass("close").html('<span aria-hidden="true">&times;</span>'),i="<strong>"+t+"</strong> "+e,r=$("#alert-space");n.html(i).prepend(o),n.appendTo(r),r.children().length>3&&r.children().first().alert("close")}function clearLists(t){"use strict";classList=[],shadowList={},t!==!0&&(classLocations={})}function checkVisible(t,e){var n=t.getBoundingClientRect(),o=Math.max(document.documentElement.clientHeight,window.innerHeight);return e?!(n.top<0||n.bottom>=o):!(n.bottom<0||n.top>=o)}function moveClockPicker(t){var e=$(".popover.clockpicker-popover")["cp_start"===t[0].id?0:1],n=e.getBoundingClientRect(),o=Math.max(document.documentElement.clientHeight,window.innerHeight),i=n.bottom-o;console.log(e,i),i>0?(console.log(e.style.top),e.style.top=+e.style.top.replace("px","")-i+"px",$(e).find(".arrow").hide()):$(e).find(".arrow").show()}var finishedInit=!1,courseList=["CBS"],classList=[],shadowList={},classLocations={},ttCellHeight=50,ttHeadHeight=40,waitingScripts=0,timetableData={},metadata={},customClasses=[],optionMemory={};$.fn.push=function(t){"use strict";return Array.prototype.push.apply(this,$.makeArray($(t))),this},function(){"use strict";$(document).ready(function(){createTable(),$("#showcap").change(function(){var t=$(".class-capacity:parent");document.getElementById("showcap").checked===!0?t.show():t.hide()}),$("#showloc").change(function(){var t=$(".class-location:parent");document.getElementById("showloc").checked===!0?t.show():t.hide()}),$(".savedOption").change(function(){saveState()}),$(".generateOption").change(function(){updateWarning()}),$("#saveimage").click(function(){timetableToPNG()}),$("#addcustom").click(function(){addCustom()}),$("#customClass").on("hidden.bs.modal",function(){document.getElementById("addcustom").innerHTML="Add",document.getElementById("customID").value=""}),$("#customClass input").change(function(){checkFields()}),$('#customClass input[type="text"]').keyup(function(){checkFields()}),$('[data-toggle="tooltip"]').tooltip({container:"body"}),objectFitImages()}),$.getJSON("data/timetable.json",function(t){timetableData=t[0],metadata=t[1],$(document).ready(function(){var e;if(document.getElementById("meta-sem").innerHTML=metadata.sem,document.getElementById("meta-year").innerHTML=metadata.year,document.getElementById("meta-update").innerHTML=metadata.updated+" at "+metadata.uptimed,init_typeahead(),e=Cookies.getJSON("prevVisit")||!1,e===!1){var n=getRandomInt();Cookies.set("prevVisit",[n,1],{expires:182}),$("#helppanel").modal("show"),pageNotice("Did you know?","You can move classes around in the timetable below to suit you better!")}else e[1]+=1,e[1]%3===0&&pageNotice("Did you know?","You can move classes around in the timetable below to suit you better!"),Cookies.set("prevVisit",e,{expires:182}),restoreState(t);var o=$("#cp_start").clockpicker({placement:"bottom",align:"left","default":12,twelvehour:!0,amOrPm:"PM",breakHour:9,afterShow:function(){moveClockPicker(o)},afterUpdate:function(){checkFields()}}),i=$("#cp_end").clockpicker({placement:"bottom",align:"left","default":12,twelvehour:!0,amOrPm:"PM",breakHour:10,afterShow:function(){moveClockPicker(i)},afterUpdate:function(){checkFields()}});finishedInit=!0})})}();
