function init_typeahead(){"use strict";for(var e=function(e){return function(t,i){var a,s=[],n=[],o=courseList;for(t=t.toLowerCase(),a=0;a<e.length;a+=1){var r=e[a];if(!(o.indexOf(r)>=0)){var c=r+" - "+timetableData[r][0],l=c.toLowerCase().indexOf(t);l>0?s.push(c):0===l&&n.push(c)}}n.sort(),n.length<10&&s.length>0&&(s.sort(),n=n.concat(s)),i(n.slice(0,10))}};void 0===$().typeahead;);$(".typeahead.coursein").typeahead({name:"courses",source:e(Object.keys(timetableData))})}function clearCourses(){removeCourseAnim=!1,$(".remove-icon").each(function(e,t){t.click()}),removeCourseAnim=!0}function restoreState(){"use strict";var e=Cookies.getJSON("options"),t=Cookies.getJSON("courses")||[],i=Cookies.getJSON("classLocations")||{},s=Cookies.getJSON("custom")||[];restoreFromData(e,t,i,s)}function restoreBackup(e){"use strict";clearCourses();var t=e[0],i=e[1],s=e[2],n=e[3];restoreFromData(t,i,s,n),saveState()}function restoreFromData(e,t,i,s){var n;if(classLocations=i,customClasses=s,void 0!==e){for(n=0;n<t.length;n+=1)"CBS"!==t[n]&&timetableData.hasOwnProperty(t[n])&&addCourse(t[n]+" - "+timetableData[t[n]][0],!1,!1);for(n=0;n<customClasses.length;n+=1){var o=addCourse(customClasses[n].component,!0,!1);o.data("custom",customClasses[n].course)}document.getElementById("tbt").checked=e.cbs.tbt,document.getElementById("bib").checked=e.cbs.bib,document.getElementById("ctr").checked=e.cbs.ctr,document.getElementById("cth").checked=e.cbs.cth,document.getElementById("showcap").checked=e.showcap,document.getElementById("fullclasses").checked=e.fullclasses,document.getElementById("showloc").checked=e.showloc,"{}"!==JSON.stringify(classLocations)&&generate(!0,!0)}}function getOptions(){var e={cbs:{}};return e.cbs.tbt=document.getElementById("tbt").checked,e.cbs.bib=document.getElementById("bib").checked,e.cbs.ctr=document.getElementById("ctr").checked,e.cbs.cth=document.getElementById("cth").checked,e.showcap=document.getElementById("showcap").checked,e.showloc=document.getElementById("showloc").checked,e.fullclasses=document.getElementById("fullclasses").checked,e}function saveState(){"use strict";if(finishedInit){var e=getOptions();Cookies.set("options",e,{expires:182}),Cookies.set("classLocations",classLocations,{expires:182}),Cookies.set("courses",courseList,{expires:182}),Cookies.set("custom",customClasses,{expires:182})}}function saveBackup(){"use strict";var e=courseList,t=customClasses,i=getOptions(),s=classLocations,n=[i,e,s,t];download(JSON.stringify(n),"timetable.json","application/json")}function restoreClasses(){"use strict";function e(e,t){e.detach().appendTo(t).css({position:"absolute",left:0,top:0})}var t,i,s,n,o;for(t in classLocations)classLocations.hasOwnProperty(t)&&(i=$('[id="'+t+'"]'),s=shadowList[t],n=$("#"+classLocations[t]),o=n.find(s),e(i,n),i.find(".class-capacity").html(o.data("capacity")))}function readBackup(e){console.log(e.type);var t=new FileReader;t.onload=function(e){try{var t=JSON.parse(e.target.result);restoreBackup(t)}catch(i){pageError("Sorry,","that backup file isn't in the right format, so we couldn't read it.")}},t.readAsText(e)}function removeCourse(e){"use strict";var t=$(e.currentTarget).parents(".course"),i=t.children().first(),s=i.html().replace(/ -.+/,"");if(t.data("custom")!==!1){for(var n=0;n<customClasses.length;n+=1)if(customClasses[n].course===t.data("custom")){customClasses.splice(n,1);break}}else-1!==courseList.indexOf(s)&&courseList.splice(courseList.indexOf(s),1);var o=function(){t.remove(),0===$("#courses").children().length&&$("#courses").css("margin-bottom","-10px")};removeCourseAnim===!0?t.children().fadeOut(200,function(){t.children().show().css("visibility","hidden"),t.slideUp(200,o)}):o(),saveState()}function addCourse(e,t,i){"use strict";t!==!0&&courseList.push(e.replace(/ -.*/,""));var s=$("#courses"),n=$("<span>").addClass("glyphicon glyphicon-remove-circle glyphicon-clickable remove-icon").attr("aria-hidden",!0).attr("data-toggle","tooltip").attr("title","Remove").click(removeCourse),o=$("<span>").addClass("glyphicon glyphicon-edit glyphicon-clickable edit-icon").attr("data-toggle","tooltip").attr("title","Edit").attr("aria-hidden",!0).attr("data-toggle","modal").attr("data-target","#customClass").click(showEdit),a=$("<div>").append(n),r=t!==!0?a:a.prepend(o),c=$('<div class="course">').html("<div>"+e+"</div>").append(r).data("custom",!1);return s.append(c).css("margin-bottom",0),i!==!1&&(c.children().hide(),c.hide().slideDown(200,function(){c.children().fadeIn(200)})),saveState(),c}function to24H(e){if(void 0===e||0===e.length)return void 0;var t=parseInt(e.replace(/\D.*/,""))%12,i=0!==parseInt(e.replace(/\d+:/,"").replace(/ .M/,""));return t+(-1!==e.indexOf("PM")?12:0)+(i?.5:0)}function to12H(e){if(void 0===e||""===e)return void 0;var t=Math.floor(e%12===0?12:e%12),i=e%1===0?"00":"30",s=(10>t?"0"+t:t)+":"+i+" "+(e>=12?"PM":"AM");return s}function getRandomInt(e,t){return e=Math.ceil(e||0),t=Math.floor(t||1e6),Math.floor(Math.random()*(t-e))+e}function uniqueID(){var t,e="custom"+getRandomInt()+"_";for(t=0;t<customClasses.length;t+=1)if(customClasses[t].course===e)return uniqueID();return e}function getRGB(e){var t=e.replace("rgba(","").replace("rgb(","").replace(")","").split(",");return t.length>3&&t.pop(),t.join(",").replace(/ /g,"")}function addCustom(){"use strict";for(var e=document.getElementById("customTitle").value,t=document.getElementById("customLocation").value,i=to24H(document.getElementById("startTime").value),s=to24H(document.getElementById("endTime").value),n=$('input[type="radio"][name="customDay"]').parent(".active").data("day"),o=n+" "+i+(s-i!==1?"-"+s:""),a=document.getElementById("customID").value||uniqueID(),r=getRGB(getComputedStyle(document.querySelector('input[type="radio"][name="customColour"]:checked + label'),":before").getPropertyValue("background-color")),c={time:o,status:"O",enrols:"0,1",course:a,component:e,location:[t],colour:r},l=0;l<customClasses.length;l+=1)if(customClasses[l].course===a){customClasses.splice(l,1);break}customClasses.push(c);var u;"Edit"===document.getElementById("addcustom").innerHTML?($("#courses").children().filter(function(e,t){return $(t).data("custom")===a}).remove(),u=addCourse(e,!0,!1)):u=addCourse(e,!0),u.data("custom",a)}function showEdit(e){"use strict";for(var n,t=$(e.target).parents(".course"),i=t.children().first().html(),s=t.data("custom"),o=0;o<customClasses.length;o+=1)if(customClasses[o].course===s){n=customClasses[o];break}void 0===n&&pageError("Oops!","The list of your courses is a bit confused. Please try reloading the page, or adding your courses again.");var a=n.time.replace(/.* /,"").split("-"),r=n.time.replace(/ .*/,"");1===a.length&&(a[1]=+a[0]+1),document.getElementById("customID").value=s,document.getElementById("addcustom").innerHTML="Edit",document.getElementById("customTitle").value=i,document.getElementById("customLocation").value=n.location,document.getElementById("startTime").value=to12H(a[0]),document.getElementById("endTime").value=to12H(a[1]),$('input[type="radio"][name="customColour"]').next().each(function(e,t){$(t).prev()[0].checked=!1,getRGB(getComputedStyle(t,":before").getPropertyValue("background-color"))===getRGB(n.colour)&&($(t).prev()[0].checked=!0)}),$('input[type="radio"][name="customDay"]').parent().removeClass("active"),$('input[type="radio"][name="customDay"]').parent('[data-day="'+r+'"]').addClass("active"),checkFields()}function checkFields(){var e=document.getElementById("startTime"),t=document.getElementById("endTime"),i=to24H(e.value),s=to24H(t.value),n=$('input[type="radio"][name="customDay"]').parent(".active").data("day"),o=document.getElementById("customTitle").value,a=document.getElementById("addcustom");return void 0===s&&void 0!==i&&(s=to12H(i+1),t.value=s),void 0===i||void 0===s?(a.disabled=!0,!1):i>=s?(t.style.color="red",a.disabled=!0,!1):(t.style.color="",void 0===n||void 0===o||""===o?(a.disabled=!0,!1):(a.disabled=!1,!0))}function canSaveTimetable(){var e=/constructor/i.test(window.HTMLElement)||function(e){return"[object SafariRemoteNotification]"===e.toString()}(!window.safari||"undefined"!=typeof safari&&safari.pushNotification),t=!!document.documentMode,i=!t&&!!window.StyleMedia;return!e&&!i&&!t}function timetableToPNG(){"use strict";var e=document.getElementById("timetable");phantomScreenshot(e)}function phantomScreenshot(e,t,i){t=t||"png",i=i||"ak-9tcg0-2mz50-jn8n9-d2y7z-p4jd7";var s=$(e).height(),n=inlineit.compile(e);$.ajax({url:"https://phantomjscloud.com/api/browser/v2/"+i+"/",method:"POST",cache:!1,contentType:"application/json; charset=UTF-8",data:JSON.stringify({content:n,url:"about:blank",renderType:t,renderSettings:{viewport:{width:720,height:s},clipRectangle:{width:720,height:s}},requestSettings:{waitInterval:0},outputAsJson:!0}),success:function(e){download("data:image/"+t+";base64,"+e.content.data,"timetable."+t,"image/"+t)},error:function(){"a-demo-key-with-low-quota-per-ip-address"!==i?phantomScreenshot(e,t,"a-demo-key-with-low-quota-per-ip-address"):pageError("Sorry,","we couldn't turn your timetable into an image at this time. Please try again later.")}})}function hasClass(e,t){"use strict";var i=" "+e.className+" ";return-1!==i.indexOf(" "+t+" ")}function createTable(){"use strict";var l,u,d,f,e=$("#timetable").find(".row"),t='<div class="col col-1 head first"></div><div class="col head">Monday</div><div class="col head">Tuesday</div><div class="col head">Wednesday</div><div class="col head">Thursday</div><div class="col head">Friday</div>',i="",s='<div class="w-100"></div>',n=8,o=21,a=function(e,t){var i="small",s=e;return e+=":00",t===!0&&(s+="_30",e="",i="half"),'<div class="col col-1 body first '+i+'" id="ttrow_'+s+'">'+(t?"":"<div>"+e.replace("_",":")+"</div>")+"</div>"},r=function(e,t,i){var s="";return i===!0&&(e+="_30",s=" half"),'<div class="col body'+s+'" id="'+t+"_"+e+'"></div>'},c=["M","T","W","H","F"];for(l=0;2*(o-n)>l;l+=1){for(u=n+Math.floor(l/2),f=l%2===1,i+=a(u,f),d=0;d<c.length;d+=1)i+=r(u,c[d],f);l!==2*(o-n)-1&&(i+=s)}e.html(t+s+i)}function showEmpty(){"use strict";$("#timetable").find(".body").css("display","block")}function hideEmpty(e,t){"use strict";var s,i=$("#timetable").find(".body");for(s=0;s<i.length;s+=1){var n=i[s],o=ttHeadHeight+ttCellHeight*+n.id.replace(/\D+_/,"").replace("_30","");(e>o||o>=t)&&(n.style.display="none")}}function getColour(e){"use strict";var t=[[31,26,178],[197,0,0],[83,15,173],[0,158,0],[255,170,0],[255,73,0],[0,118,118],[205,0,116]];return t[e%t.length].join(",")}function startDrag(e,t){"use strict";var i=$(e.target),s=i.attr("id"),n=shadowList[s];n.filter(function(){return document.getElementById("fullclasses").checked||"F"!==$(this).data("status")}).fadeIn(200),$('.class-drag[id^="'+s.replace(/\d$/,"")+'"]').addClass("locked")}function stopDrag(e,t){"use strict";function i(e,t){e.detach().appendTo(t).css({left:0,top:0,position:null})}var a,r,s=$(e.target),n=2500,o=null;$(".class-shadow:visible").each(function(){var e=$(this).offset(),t=s.offset(),i=Math.pow(e.left-t.left,2)+Math.pow(e.top-t.top,2);n>i&&(n=i,o=$(this))}),null!==o?(a=s.attr("id"),r=shadowList[a].index(o),$('.class-drag[id^="'+a.replace(/\d$/,"")+'"]').each(function(){var e=$(this),t=$(shadowList[e.attr("id")][r]);i(e,t.parent()),e.find(".class-capacity").html(t.data("capacity")),e.find(".class-location").html(t.data("location")),classLocations[e.attr("id")]!==t.parent().attr("id")&&e.css("z-index",s.css("z-index")),classLocations[e.attr("id")]=t.parent().attr("id"),e.removeClass("hovering")})):(a=s.attr("id"),$('.class-drag[id^="'+a.replace(/\d$/,"")+'"]').each(function(){var e=$(this);e.addClass("hovering")})),$(".class-shadow").fadeOut(200),$(".class-drag.locked").removeClass("locked"),saveState()}function checkFullClasses(){$(".class-drag").each(function(){if(document.getElementById("fullclasses").checked===!1){var e=$(this),t=e.parent().children(".class-shadow").filter(function(){return"F"!==$(this).data("status")}).filter(shadowList[this.id]);0===t.length&&e.addClass("hovering")}else 0===+this.style.top.replace("px","")&&0===+this.style.left.replace("px","")&&$(this).removeClass("hovering")})}function unique(e,t){"use strict";var o,i=[],s=[],n=[];for(o=0;o<e.length;o+=1)-1===n.indexOf(String(e[o]))&&(i.push(e[o]),n.push(String(e[o])),void 0!==t&&s.push(t[o]));for(o=0;o<i.length;o+=1)e[o]=i[o],void 0!==t&&(t[o]=s[o]);for(;o<e.length;)e.pop(),void 0!==t&&t.pop()}function createClassDiv(e,t,i,s,n,o,a){"use strict";var r=$("<div>").attr("id",s).addClass("class-drag").draggable({stack:".class-drag",scroll:!0,containment:a,start:startDrag,stop:stopDrag}),c=r[0];return c.innerHTML="<div>"+e+t+i+"</div>",c.style.position="absolute",c.style.backgroundColor="rgb("+n+")",c.style.height=ttCellHeight*o+"px",r}function createClass(e,t,i){"use strict";var l,u,d,f,h,m,p,g,s=e.time,n=e.enrols,o=e.course,a=e.component,r=e.location,c=e.colour||getColour(t),v='<div style="font-weight: bold">'+(0!==o.indexOf("custom")&&"CBS"!==o?o+": "+a:a)+"</div>",y=0,b=$("#timetable").find(".row");for(n=0!==o.indexOf("custom")&&"CBS"!==o?'<div class="class-capacity">'+n.replace(","," / ")+"</div>":"",d=0;d<s.length;d+=1){l=s[d],u='<div class="class-location">'+r[d]+"</div>";var k=l.join(",")+o+a;-1===i.indexOf(k)?(i.push(k),f=o+a+"_"+(d-y),h=l[2]-l[1],m=(l[0]+"_"+l[1]).replace(".5","_30"),p=$("#"+m),g=createClassDiv(v,u,n,f,c,h,b),""===n&&g.addClass("nocapacity"),g.appendTo(p),classList.push(g),classLocations.hasOwnProperty(f)||(classLocations[f]=m)):y+=1}document.getElementById("showcap").checked||$(".class-capacity").hide(),document.getElementById("showloc").checked||$(".class-location").hide()}function createShadow(e,t){"use strict";var i=e.time,s=e.course+e.component+"_",n=e.enrols,o=e.location,a=e.colour||getColour(t),r=1/0,c=-(1/0);(0===s.indexOf("CBS")||0===e.course.indexOf("custom"))&&(n=""),unique(i,o);var l;for(l=0;l<i.length;l+=1){var b,u=i[l],f=(u.join(","),o[l]),h=s+l,m=u[2]-u[1],p=ttCellHeight*m,g=(u[0]+"_"+u[1]).replace(".5","_30"),v=$("#"+g),y=ttHeadHeight+u[1]*ttCellHeight;b=$('<div class="class-shadow">'),b[0].style.backgroundColor="rgba("+a+", 0.7)",b[0].style.height=p+"px",b.data("capacity",n.replace(","," / ")),b.data("location",f.replace(","," / ")),b.data("status",e.status),b.appendTo(v),shadowList.hasOwnProperty(h)?shadowList[h]=shadowList[h].push(b):shadowList[h]=b,r=Math.min(r,-1===g.indexOf("_30")?y:y-ttCellHeight/2),c=Math.max(c,y+p)}return{min:r,max:c}}function pageError(e,t){var i=$("<div>").addClass("alert alert-warning alert-dismissible fade show").attr("role","alert"),s=$('<button type="button" data-dismiss="alert" aria-label="Close">').addClass("close").html('<span aria-hidden="true">&times;</span>'),n="<strong>"+e+"</strong> "+t,o=$("#alert-space");i.html(n).prepend(s),i.appendTo(o),o.children().length>3&&o.children().first().alert("close")}function pageNotice(e,t){var i=$("<div>").addClass("alert alert-success alert-dismissible fade show").attr("role","alert"),s=$('<button type="button" data-dismiss="alert" aria-label="Close">').addClass("close").html('<span aria-hidden="true">&times;</span>'),n="<strong>"+e+"</strong> "+t,o=$("#alert-space");i.html(n).prepend(s),i.appendTo(o),o.children().length>3&&o.children().first().alert("close")}function clearLists(e){"use strict";classList=[],shadowList={},e!==!0&&(classLocations={})}function checkVisible(e,t){var i=e.getBoundingClientRect(),s=Math.max(document.documentElement.clientHeight,window.innerHeight);return t?!(i.top<0||i.bottom>=s):!(i.bottom<0||i.top>=s)}function moveClockPicker(e){var i,t=$(".popover.clockpicker-popover");i="cp_start"===e[0].id?t.first()[0]:t.last()[0];var s=i.getBoundingClientRect(),n=Math.max(document.documentElement.clientHeight,window.innerHeight),o=s.bottom-n;o>0?(i.style.top=+i.style.top.replace("px","")-o+"px",$(i).find(".arrow").hide()):$(i).find(".arrow").show()}function createMenuShadow(){document.getElementById("menu-shadow").innerHTML=document.getElementById("ddmenu").innerHTML.replace(/ id="[^"]*"/g,"")}function showMenu(){$("#ddmenu").slideDown(200),$("#menu-shadow").slideDown(200)}function hideMenu(){$("#ddmenu").slideUp(200),$("#menu-shadow").slideUp(200)}var finishedInit=!1,courseList=["CBS"],classList=[],shadowList={},classLocations={},ttCellHeight=50,ttHeadHeight=40,waitingScripts=0,timetableData={},components_index={},locations_index={},times_index={},metadata={},customClasses=[],optionMemory={},removeCourseAnim=!0;$.fn.push=function(e){"use strict";return Array.prototype.push.apply(this,$.makeArray($(e))),this},function(){"use strict";$(document).ready(function(){createTable(),createMenuShadow(),$("#ddmenu-toggle").click(function(){0===$("#ddmenu:visible").length?showMenu():hideMenu()}),$("#ddmenu").click(hideMenu),$("#maincontainer").mousedown(hideMenu),$("footer.footer").mousedown(hideMenu),$("#showcap").change(function(){var e=$(".class-capacity:parent");document.getElementById("showcap").checked===!0?e.show():e.hide()}),$("#showloc").change(function(){var e=$(".class-location:parent");document.getElementById("showloc").checked===!0?e.show():e.hide()}),$(".savedOption").change(saveState),$("#fullclasses").change(checkFullClasses),$("#generate").click(generate),$("#menu-generate").click(generate),$("#saveimage").click(timetableToPNG),$("#menu-download").click(timetableToPNG),$("#menu-saveback").click(saveBackup),$("#menu-loadback").click(function(){document.getElementById("fileinput").click()}),$("#fileinput").change(function(){var e=document.getElementById("fileinput");readBackup(e.files[0]),e.value=""}),$("#addcustom").click(addCustom),$("#customClass").on("hidden.bs.modal",function(){document.getElementById("addcustom").innerHTML="Add",document.getElementById("customID").value=""}),$("#customClass input").change(checkFields),$('#customClass input[type="text"]').keyup(checkFields),$('[data-toggle="tooltip"]').tooltip({container:"body"}),objectFitImages()}),$.getJSON("data/timetable.json",function(e){function t(e,t){for(e=""+e;e.length<t;)e+="0";return e}var i,s;for(i in e[0])if(e[0].hasOwnProperty(i))for(s in e[0][i])e[0][i].hasOwnProperty(s)&&(timetableData[i+t(s,4)]=e[0][i][s]);components_index=e[1],locations_index=e[2],times_index=e[3],metadata=e[4],$(document).ready(function(){var e;if(document.getElementById("meta-sem").innerHTML=metadata.sem,document.getElementById("meta-year").innerHTML=metadata.year,document.getElementById("meta-update").innerHTML=metadata.updated+" at "+metadata.uptimed,init_typeahead(),e=Cookies.getJSON("prevVisit")||!1,e===!1){var t=getRandomInt();Cookies.set("prevVisit",[t,1],{expires:182}),$("#helppanel").modal("show"),pageNotice("Did you know?","You can move classes around in the timetable below to suit you better!")}else e[1]+=1,e[1]%3===0&&pageNotice("Did you know?","You can move classes around in the timetable below to suit you better!"),Cookies.set("prevVisit",e,{expires:182}),restoreState();var i=$("#cp_start").clockpicker({placement:"bottom",align:"left","default":12,twelvehour:!0,amOrPm:"PM",breakHour:9,afterShow:function(){moveClockPicker(i)},afterUpdate:checkFields}),s=$("#cp_end").clockpicker({placement:"bottom",align:"left","default":12,twelvehour:!0,amOrPm:"PM",breakHour:9.5,afterShow:function(){moveClockPicker(s)},afterUpdate:checkFields});finishedInit=!0})})}();
